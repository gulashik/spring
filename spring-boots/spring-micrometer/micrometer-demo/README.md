                                                  # Micrometer Demo

Демонстрационный проект Spring Boot, показывающий возможности Micrometer для мониторинга и трассировки приложений.

## Содержание

- [Обзор](#обзор)
- [Требования](#требования)
- [Установка и запуск](#установка-и-запуск)
- [Архитектура проекта](#архитектура-проекта)
- [Демонстрируемые возможности](#демонстрируемые-возможности)
- [API Endpoints](#api-endpoints)
- [Мониторинг](#мониторинг)
- [Best Practices](#best-practices)

## Обзор

Micrometer - это фасад для инструментирования приложений на JVM, предоставляющий единый API для сбора метрик и их экспорта в различные системы мониторинга. Он позволяет разработчикам не привязываться к конкретной системе мониторинга и легко переключаться между ними.

Этот проект демонстрирует:
- Основные типы метрик (Counter, Gauge, Timer, DistributionSummary)
- Интеграцию с различными системами мониторинга (Prometheus, InfluxDB)
- Использование трассировки с Micrometer
- Настройку метрик и их экспорта
- Best practices при работе с метриками

## Требования

- Java 21
- Maven 3.8+
- Docker и Docker Compose (для запуска Prometheus, Grafana и Zipkin)

## Установка и запуск

### Локальный запуск

```bash
# Клонирование репозитория
git clone https://github.com/yourusername/micrometer-demo.git
cd micrometer-demo

# Сборка проекта
./mvnw clean package

# Запуск приложения
java -jar target/micromet-0.0.1-SNAPSHOT.jar
```

### Запуск с Docker Compose

```bash
# Сборка образа и запуск всех сервисов
docker-compose up -d

# Для остановки сервисов
docker-compose down
```

После запуска сервисы будут доступны по следующим адресам:
- Spring Boot приложение: http://localhost:8080
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (логин: admin, пароль: admin)
- Zipkin: http://localhost:9411

## Архитектура проекта

```
src/main/java/org/gualsh/demo/micromet/
├── MicrometerDemoApplication.java    # Главный класс приложения
├── config/
│   └── MicrometerConfig.java         # Конфигурация Micrometer
├── controller/
│   ├── CountersController.java       # Контроллер для демонстрации счетчиков
│   ├── DemoController.java           # Основной контроллер приложения
│   ├── MetricsController.java        # Контроллер для работы с метриками
│   └── TracingController.java        # Контроллер для демонстрации трассировки
├── metrics/
│   ├── CoreMetricsDemo.java          # Демонстрация основных типов метрик
│   └── CustomMetricsBinder.java      # Пользовательские метрики
├── scheduler/
│   └── DemoScheduler.java            # Планировщик для демонстрации фоновых задач
├── service/
│   └── OrderProcessingService.java   # Сервис для имитации бизнес-логики
└── tracing/
    └── TracingDemo.java              # Демонстрация трассировки
```

## Демонстрируемые возможности

### 1. Основные типы метрик

- **Counter** - счетчик, который может только увеличиваться
- **Gauge** - значение, которое может увеличиваться и уменьшаться
- **Timer** - для измерения длительности операций
- **DistributionSummary** - для произвольных числовых распределений
- **LongTaskTimer** - для измерения длительных задач

### 2. Особенности Micrometer

- **Тегирование метрик** - добавление меток для сегментации
- **Многомерные метрики** - использование тегов для создания многомерных метрик
- **Фильтрация метрик** - ограничение и преобразование метрик
- **Percentiles** - настройка процентилей для таймеров и распределений
- **Annotation-based метрики** - использование аннотаций @Timed и @Counted

### 3. Трассировка

- **Observation API** - унифицированный API для метрик и трассировки
- **Вложенные наблюдения** - создание вложенных трейсов
- **Добавление контекста** - обогащение трейсов дополнительной информацией

## API Endpoints

### Основные эндпоинты

- **GET /api/status** - получение статуса сервера (демонстрация @Timed)
- **GET /api/resources** - получение информации о ресурсах (демонстрация ручного Timer)
- **POST /api/orders** - создание заказа (демонстрация бизнес-метрик)
- **GET /api/error/{type}** - генерация ошибок для тестирования
- **GET /api/load-test** - генерация нагрузки для тестирования метрик

### Метрики

- **GET /api/metrics/list** - список всех доступных метрик
- **GET /api/metrics/search?prefix={prefix}** - поиск метрик по префиксу
- **GET /api/metrics/info?name={name}** - информация о конкретной метрике
- **GET /api/metrics/summary** - сводная информация о метриках

### Трассировка

- **GET /api/tracing/demo** - демонстрация трассировки
- **GET /api/tracing/operation?operationName={name}** - пользовательская операция с трассировкой
- **GET /api/tracing/resource/{id}** - получение ресурса с трассировкой
- **GET /api/tracing/error** - генерация ошибки для трассировки

### Счетчики

- **POST /api/counters/operation?value={value}** - выполнение операции с счетчиками
- **GET /api/counters/count/{type}** - демонстрация @Counted
- **GET /api/counters/process?parameter={param}** - демонстрация комбинации @Timed и @Counted
- **POST /api/counters/dynamic/{category}** - создание динамического счетчика

### Actuator

Приложение имеет полный набор эндпоинтов Spring Boot Actuator:

- **GET /actuator/health** - информация о здоровье приложения
- **GET /actuator/info** - информация о приложении
- **GET /actuator/metrics** - список доступных метрик
- **GET /actuator/metrics/{name}** - детали конкретной метрики
- **GET /actuator/prometheus** - экспорт метрик в формате Prometheus

## Мониторинг

### Prometheus

Приложение экспортирует метрики в формате Prometheus через эндпоинт `/actuator/prometheus`. Prometheus настроен на сбор метрик каждые 15 секунд.

Основные запросы Prometheus:

```
# HTTP запросы в секунду
rate(http_server_requests_seconds_count{job="spring-boot-app"}[1m])

# 95 процентиль времени ответа
histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{job="spring-boot-app"}[1m])) by (le, uri))

# Количество заказов в секунду
rate(business_orders_total{job="spring-boot-app"}[1m])

# Использование CPU
system_cpu_usage{job="spring-boot-app"}

# Использование памяти JVM
jvm_memory_used_bytes{job="spring-boot-app", area="heap"}
```

### Grafana

Предустановленные дашборды Grafana включают:
- Использование CPU и памяти
- HTTP запросы (количество, время отклика, ошибки)
- Бизнес-метрики (заказы, обработка)
- JVM метрики (память, GC, потоки)

## Best Practices

### Именование метрик

- Используйте структуру `domain.type.action` для имен метрик
- Примеры: `http.server.requests`, `business.orders.total`
- Будьте последовательны в именовании

### Теги и многомерные метрики

- Используйте теги для сегментации данных, а не создавайте отдельные метрики
- Применяйте согласованные имена тегов
- Различайте теги с высокой и низкой кардинальностью

### Производительность

- Используйте `Gauge` только когда необходимо
- Применяйте фильтры для ограничения количества метрик
- Ограничивайте использование процентилей для таймеров
- Используйте `distributionStatisticExpiry` для ограничения истории процентилей

### Обработка ошибок

- Не выбрасывайте исключения в функциях, используемых для метрик
- Проверяйте безопасность вызовов в функциях для Gauge
- Используйте тег `status` для отслеживания успешных и неуспешных операций

### Интеграция с бизнес-логикой

- Инструментируйте ключевые бизнес-операции
- Используйте Timer для критичных по времени операций
- Отслеживайте бизнес-показатели через метрики
- Разделяйте инфраструктурные и бизнес-метрики

### Spring Boot Actuator

- Выборочно включайте только нужные эндпоинты
- Настраивайте безопасность для эндпоинтов Actuator
- Используйте кэширование для метрик

## Системы мониторинга

### Поддерживаемые системы мониторинга

Micrometer поддерживает интеграцию со следующими системами:

- **Prometheus** - система мониторинга с моделью извлечения данных
- **InfluxDB** - база данных временных рядов
- **Elastic** - использование Elastic для хранения метрик
- **Datadog** - служба мониторинга как сервис
- **New Relic** - платформа мониторинга производительности
- **StatsD** - сервис сбора и агрегации статистики
- **Graphite** - система хранения и визуализации метрик
- **JMX** - Java Management Extensions
- **Wavefront** - платформа мониторинга в реальном времени
- **SignalFx** - служба мониторинга и аналитики
- **AWS CloudWatch** - служба мониторинга от Amazon

### Выбор системы мониторинга

При выборе системы мониторинга, учитывайте:
- Модель сбора данных (push vs. pull)
- Возможности по хранению и агрегации данных
- Визуализация и создание дашбордов
- Масштабируемость и производительность
- Поддержка алертинга
- Интеграция с другими инструментами

## Особенности Micrometer

### Преимущества Micrometer

- **Единый API** - один API для всех систем мониторинга
- **Низкие накладные расходы** - оптимизация производительности
- **Готовая интеграция со Spring Boot** - автоматическая настройка
- **Богатый набор встроенных метрик** - JVM, системные, веб и т.д.
- **Поддержка различных систем регистрации** - легкая замена системы мониторинга

### Umolchaniya (настройки по умолчанию)

- Автоматически регистрируется MeterRegistry
- Spring Boot включает набор стандартных биндеров для JVM, системы, Tomcat и т.д.
- По умолчанию включены метрики HTTP запросов
- Actuator автоматически экспортирует метрики

### Трассировка и наблюдаемость

- Трассировка дополняет метрики и логирование
- Новый Observation API объединяет метрики и трассировку
- Интеграция с Zipkin, Jaeger, OpenTracing
- Автоматическая трассировка HTTP запросов в Spring Boot

## Примеры запросов

Вот несколько примеров запросов для тестирования нашего API:

### Создание заказа

```bash
curl -X POST -H "Content-Type: application/json" -d '{"amount": 350.5, "region": "eu"}' http://localhost:8080/api/orders
```

### Запуск нагрузочного тестирования

```bash
curl http://localhost:8080/api/load-test?seconds=30
```

### Тестирование метрик трассировки

```bash
curl http://localhost:8080/api/tracing/demo
```

### Получение списка всех метрик

```bash
curl http://localhost:8080/api/metrics/list
```

### Получение информации о конкретной метрике

```bash
curl http://localhost:8080/api/metrics/info?name=jvm.memory.used
```

## Заключение

Micrometer предоставляет мощный и гибкий инструмент для мониторинга приложений Spring Boot. Этот демонстрационный проект показывает основные возможности и практики использования Micrometer в реальных приложениях. Используйте его как отправную точку для добавления мониторинга в ваши приложения.

Для более детальной информации обращайтесь к официальной документации:
- [Micrometer Documentation](https://micrometer.io/docs)
- [Spring Boot Actuator Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html)